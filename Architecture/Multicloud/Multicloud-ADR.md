# Реализация multicloud развертывания сосисочной

## Контекст и постановка проблемы

Для расширения бизнеса компании и увеличения прибыли было принято решение продавать сосиски не только в России, 
но и в других странах.
В связи с этим требованием бизнеса требуется продумать решение развертывания компонентов сосисочной в облаках, 
отличных от Yandex Cloud, т.к Yandex Cloud не удовлетворяет требованиям законодательства других стран.  
Для этого нужно понять поддерживает ли наша сосичноая мультиразвертывание в нескольких облачных провайдерах,
каким образом мы будем обрабатывать данные по заказам в нескольких странах, и каким образом реализуем балансировку 
пользователей, которые будут обращаться к сосисочной из разных стран в нужные инстансы.

## Анализ возможности multicloud развертывания сосисочной
Приложение сосисочной соответствует методологии [Twelve-factor app](https://12factor.net/), 
а также является [Cloud Native](https://aws.amazon.com/what-is/cloud-native/#:~:text=The%20term%20cloud%20native%20refers,container%20orchestrators%2C%20and%20auto%20scaling.)
приложением.    
Стек приложения популярный:
- Postgres
- Mongo database
- Java, Go microservices
- Gitlab CI/CD
- k8s  

Во всех cloud провайдерах имеется поддержка данного стека, специфичные cloud функции на данный момент не используются,
проблем в реализации развертывания в multicloud конфигурации не имеется.

## Выбор Cloud провайдеров для развертывания сосисочной в multicloud конфигурации
На данный момент приложение сосисочной развернуто в Yandex Cloud инфраструктуре.
При выборе cloud провайдера нам важно:
- Какие регионы развертывания поддерживаются
- Наличие сертификатов на соответстваие законодательства стран, где мы хотим поставлять наше приложение
- Наличие managed сервисов стека сосисочной, для упрощения поддержки инфраструктуры

После анализа нескольких вариантов (AWS, Azure, Google cloud)
было принято решение выбрать AWS из-за наличия большого количества регионов развертывания,
большого количества сертификатов для соответствия законодательству различных стран, а также богатой документации.

## Реализация деплоя сосисочной в несколько инстансов, в разных cloud провайдерах
Для реализации деплоя сосисочной в несколько cloud провайдеров будет достаточно использования текущего Gitlab CI/CD.
Для хранения образов можно использовать Gitlab Container Registry.
Также возможна настройка ArgoCD, но требует дополнительных затрат подготовку инфраструктуры.

## Балансировка пользователей между разными региональными инстансами

Для балансировки траффика между несколькими региональными инстансами можно использовать балансировки нагрузки на основе 
GSLB, которые можно настроить для маршрутизации в инстанс с минимальным latency, также можно использовать CDN сети.  
Важным требованием является поиск продукта, который будет поддерживать маршрутизацию в формате multicloud, в текущей
ситуации может быть проблемой найти продукт, который сможет маршрутизировать как Российские так и зарубежные адреса.

Еще одним вариантом является развертывание отдельного адреса для сосисочной, развернутой в странах зарубежья,
и настройка отдельного CDN/GSLB для этого адреса.

## Реализация обработки данных сосисочной в разных регионах

Есть несколько вариантов решения обработки данных.
В первую очередь нужно опираться на требования законодательства страны, где мы собираемся продавать товар.
Во вторую очередь нужно ориентироваться на сложность и стоимость реализации и поддержки выбранного решения.

### Синхронизация данных между регионами

Для синхронизации данных между регионами можно использовать **репликацию кластеров БД**.

В случае с асинхронной репликацией мы будем иметь задержку перед синхронизацией данных.  
В случае с синхронной репликацией мы будем иметь более большое latency.

Вторым вариантом **использование distributed SQL баз данных**   

Минусом является отсутствие во многих cloud решениях managed distributed SQL решений.
Также потребуется доработка самого приложения.

#### Положительные последствия

При потере доступа к одному из регионов возможно переключить пользователей к другому региону (георезервирование).  
Возможность сбора общей аналитики по продажам в регионах.

#### Негативные последствия

Сложная реализация доработок инфраструктуры.
Увеличение стоимости поддержки инфраструктуры.  
Затраты по обновлению приложения для использования распределенных БД.

### Развертывание независимых инстансов в различных регионах.

В каждом из регионов будет развернута полноценная отдельнвя инсталляция сосисочной (отдельная независимая БД).

#### Положительные последствия

Проще реализовать.  
Дешевле поддерживать.  
Гарантирует соответствие законодательству стран - данные не попадут в соседние регионы.  

#### Негативные последствия

Не получится переключить траффик с одного региона на другой, в случае недоступности одного из регионов.  
Сложнее собирать общую аналитику между регионами.  


### Общая аналитика multicloud решения
В целом возможность развертывания сосисочной в различных cloud провайдерах возможна,
наше приложение на данный момент не имеет cloud provider зависимого функционала.  
Также разворачивание в нескольких облаках позволит сделать нашу инфраструктуру более отказоустойчивой и обеспечить низкую
задержку для пользователей.  

Но это потребует дополнительных затрат, и более умного управления данными приложения.  
Также цена содержания multicloud решения может стать препядствием, ведь нам нужна высококвалифицированная команда разработки,
которая умеет работать с несколькими cloud провайдерами.  
Поведение различных cloud провайдерах в идентичных сервисах может отличаться, что также повысит стоимость содержания нашего решения.

## Результат решения

### Положительные последствия


### Негативные последствия

